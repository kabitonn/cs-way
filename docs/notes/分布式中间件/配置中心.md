

# Diamond

Diamond是淘宝内部广泛使用的配置中心，提供持久化管理和动态配置推送服务。 配置的持久化管理，是Diamond与淘宝内部另外一个软负载配置产品ConfigServer的主要区别。应用方发布的配置会通过持久化存储保存，与发布者的生命周期无关。 动态配置推送，则是Diamond的核心功能，在淘宝内部有很多应用场景，如数据库动态切换和扩容，业务系统开关配置运行时变更等。

实时的动态配置推送，本质上是如何把服务端的更新状态，实时发送给客户端的问题。 TCP长连接是最自然的一种解决方案，但是由于设计上，Diamond选择了Http协议提供服务。 如何在Http协议的Request-Response通信模型下解决这个问题，是Diamond面临的难题。淘宝生产环境中的Diamond服务，采用了基于推模型的客户端长轮询的方案来实现动态配置实时推送。 基于Http长轮询模型，实现了让客户端在没有发生动态配置变更的时候减少轮询。这样减少了无意义的轮询请求量，提高了轮询的效率；也降低了系统负载，提升了整个系统的资源利用率。 另外，这种推拉结合的策略，做到了在长连接和短连接之间的平衡，实现上让服务端不用太关注连接的管理，效果上又获得了类似TCP长连接的信息推送的实时性。

Diamond的比较适合低频变更的动态配置管理，对于配置的变更只保证最终一致性，不保证过程一致性；要求接入的业务满足幂等性，有部分用户拿Diamond做事件通知，可能会导致事件丢失。

# ConfigServer

ConfigServer中文名为非持久配置中心，主要用于非持久数据的发布和订阅，数据的生命周期和TCP连接生命周期绑定，产品架构基于发布订阅模型，去中心无master设计，保证了系统的可扩展性、高可用。在集团内部主要场景为分布式消息系统Notify、分布式RPC框架HSF提供地址发现服务。

## 特性

1. 无Master架构：ConfigServer基于无Master架构ConfigServer是无中心化的架构，不存在单点问题，通过特定的算法进行数据增量同步。
2. 自动聚合：ConfigServer支持数据的自动聚合配置数据的聚合功能。每台机器向ConfigServer注册自己的服务元信息，ConfigServer会根据服务名和分组自动聚合所有元数据，提供给服务订阅方使用。
3. 实时：ConfigServer是推数据的模型ConfigServer的服务端与客户端是基于长连接的方式进行通信，在客户端订阅关系确定后，配置信息一旦发生变化，会主动推送配置数据到客户端，并回调客户端的业务监听器

## 应用场景
1. 服务发现：HSF，Notify
2. 非持久配置的发布、订阅：Mtop
3. 集群管理：天猫监控，TDD